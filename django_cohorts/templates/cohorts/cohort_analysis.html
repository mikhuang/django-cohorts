{% extends "admin/base_site.html" %}
{% load args static admin_urls admin_static admin_modify %}

{% block title %}Cohort Analysis | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}<div class="breadcrumbs"><a href="/admin/">Home</a> &rsaquo; Cohort Analysis</div>{% endblock %}
{% block content %}

<p class="paginator">
{% for method, method_name in analysis.get_metrics_choices %}
<a href="?metric={{method_name}}">{{method_name}}</a>
{% endfor %}
</p>

<h1>{% firstof metric_choice cohorts.0.analyze.metric_choice %}</h1>
<table>
    <thead>
        <tr>
            <th>Cohort</th>
            <th>Count</th>
            {% for set in analysis.date_range_set %}
            <th>Week {{ forloop.counter }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
    {% for cohort in cohorts %}
        {% with analyze=cohort|args:metric_choice|call:"analyze" %}
        <tr class="{% cycle "row1" "row2" %}">
            <th scope="row">
                <b>{{ cohort.name|date }}</b>
            </th>
            <th>{{ analyze.count }}</th>
            {% for data in analyze.analysis %}
            <td class="data-cell" data-percentage="{{data}}">{{ data|floatformat }}%</td>
            {% endfor %}
        </tr>
        {% endwith %}
    {% endfor %}
    </tbody>
</table>
{% endblock %}


{% block extrastyle %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static "admin/css/changelists.css" %}" />
{% endblock %}


{% block extrahead %}
{{ block.super }}
<script type="text/javascript" src="{% static "admin/js/vendor/jquery/jquery.js" %}"></script>
<script type="text/javascript" src="{% static "admin/js/jquery.init.js" %}"></script>
<script type="text/javascript">
    // http://stackoverflow.com/questions/14819058/mixing-two-colors-naturally-in-javascript
    //colorChannelA and colorChannelB are ints ranging from 0 to 255
    function colorChannelMixer(colorChannelA, colorChannelB, amountToMix){
        var channelA = colorChannelA*amountToMix;
        var channelB = colorChannelB*(1-amountToMix);
        return parseInt(channelA+channelB);
    }
    //rgbA and rgbB are arrays, amountToMix ranges from 0.0 to 1.0
    //example (red): rgbA = [255,0,0]
    function colorMixer(rgbA, rgbB, amountToMix){
        var r = colorChannelMixer(rgbA[0],rgbB[0],amountToMix);
        var g = colorChannelMixer(rgbA[1],rgbB[1],amountToMix);
        var b = colorChannelMixer(rgbA[2],rgbB[2],amountToMix);
        return "rgb("+r+","+g+","+b+")";
    }

    (function($) {
        $(document).ready(function($) {
            var colorA = [47, 32, 65];
            var colorB = [249, 240, 235];
            $('.data-cell').each(function() {
                var amount = $(this).data('percentage') / 100;
                var newColor = colorMixer(colorA, colorB, amount);
                $(this).css('background-color', newColor);
                if (amount > .5) {
                    $(this).css('color', '#fff');
                }
            });
        });
    })(django.jQuery);
</script>
{% endblock %}
